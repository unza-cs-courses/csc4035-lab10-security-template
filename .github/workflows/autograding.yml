name: Autograding

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    name: Run Security Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run visible tests
        id: tests
        run: |
          npm test 2>&1 | tee test_output.txt
          TEST_EXIT_CODE=${PIPESTATUS[0]}

          # Extract score from output
          SCORE=$(grep "Score:" test_output.txt | grep -o '[0-9]*' | head -1)
          PASSED=$(grep "Results:" test_output.txt | grep -o '[0-9]* passed' | grep -o '[0-9]*')
          FAILED=$(grep "Results:" test_output.txt | grep -o '[0-9]* failed' | grep -o '[0-9]*')

          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          exit $TEST_EXIT_CODE
        continue-on-error: true

      - name: Generate Test Report
        if: always()
        run: |
          echo "## Lab 10: Security Audit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Score:** ${{ steps.tests.outputs.score }}%" >> $GITHUB_STEP_SUMMARY
          echo "**Passed:** ${{ steps.tests.outputs.passed }}" >> $GITHUB_STEP_SUMMARY
          echo "**Failed:** ${{ steps.tests.outputs.failed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Output" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat test_output.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Create Results JSON
        if: always()
        run: |
          PASSED="${{ steps.tests.outputs.passed }}"
          FAILED="${{ steps.tests.outputs.failed }}"
          TOTAL=$((${PASSED:-0} + ${FAILED:-0}))

          cat > test_results.json << EOF
          {
            "summary": {
              "passed": ${PASSED:-0},
              "failed": ${FAILED:-0},
              "total": ${TOTAL}
            },
            "assignment": "lab10-security",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test_output.txt
            test_results.json
          retention-days: 30

      - name: Check test status
        if: steps.tests.outcome == 'failure'
        run: exit 1
